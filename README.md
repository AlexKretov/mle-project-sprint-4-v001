# Подготовка виртуальной машины

## Склонируйте репозиторий

Склонируйте репозиторий проекта:

```
git clone https://github.com/yandex-praktikum/mle-project-sprint-4-v001.git
```

## Активируйте виртуальное окружение

Используйте то же самое виртуальное окружение, что и созданное для работы с уроками. Если его не существует, то его следует создать.

Создать новое виртуальное окружение можно командой:

```
python3 -m venv env_recsys_start
```

После его инициализации следующей командой

```
. env_recsys_start/bin/activate
```

установите в него необходимые Python-пакеты следующей командой

```
pip install -r requirements.txt
```

### Скачайте файлы с данными

Для начала работы понадобится три файла с данными:
- [tracks.parquet](https://storage.yandexcloud.net/mle-data/ym/tracks.parquet)
- [catalog_names.parquet](https://storage.yandexcloud.net/mle-data/ym/catalog_names.parquet)
- [interactions.parquet](https://storage.yandexcloud.net/mle-data/ym/interactions.parquet)
 
Скачайте их в директорию локального репозитория. Для удобства вы можете воспользоваться командой wget:

```
wget https://storage.yandexcloud.net/mle-data/ym/tracks.parquet

wget https://storage.yandexcloud.net/mle-data/ym/catalog_names.parquet

wget https://storage.yandexcloud.net/mle-data/ym/interactions.parquet
```

## Запустите Jupyter Lab

Запустите Jupyter Lab в командной строке

```
jupyter lab --ip=0.0.0.0 --no-browser
```

# Расчёт рекомендаций

Код для выполнения первой части проекта находится в файле `recommendations.ipynb`. Изначально, это шаблон. Используйте его для выполнения первой части проекта.

# Сервис рекомендаций

Код сервиса рекомендаций находится в файле `recommendations_service.py`.

Запустите сервис (из корневой директории проекта):
python recommendations_service.py

Пример использования через curl:

curl -X GET "http://127.0.0.1:4000/get_playlist?user_id=123456" -H "accept: application/json"

Пример ответа:
```
{
  "playlist": [
    "Bohemian Rhapsody-Queen",
    "Hotel California-Eagles",
    "..."
  ],
  "stats": {
    "personal": 7,
    "similars": 3,
    "popular": 0
  }
}
```
Важные нюансы:

Для работы с S3 хранилищем требуется файл flask/.env с параметрами:  
AWS_ACCESS_KEY_ID=your_key  
AWS_SECRET_ACCESS_KEY=your_secret  
S3_BUCKET=your_bucket  

Сервис зависит от других микросервисов на портах 6000-8000. Для этого воспользуйтесь командами:  
python flask/get_similar3.py  
python flask/get_perosnal3.py  
python flask/get_history3.py  
Перед запуском убедитесь, что они доступны.  Загружаются они достаточно долго, но потом работают быстро.  

# Инструкции для тестирования сервиса

Код для тестирования сервиса находится в файле `test_service.py`.  

1. Подготовка окружения
# Установите зависимости
pip install requests pandas tqdm

2. Запуск теста
# Базовый тест (200 запросов)
python test_service.py

# Кастомная конфигурация (через переменные)
NUM_REQUESTS=500 TIMEOUT=10 python test_service.py

3. Анализ результатов
a) Консольный вывод:

Test Results:
Total requests: 200
Success rate: 92.50%
Average response time: 0.423s
Min/Max response time: 0.102s / 1.231s
Average tracks per response: 9.8

b) Лог-файл:

tail -f test_service.log  # Реальный мониторинг
grep "ERROR" test_service.log  # Поиск ошибок
c) CSV с результатами:

4. Кастомизация теста
Измените конфиг в коде:

TEST_CONFIG = {
    'base_url': 'http://your-service-url',  # Для тестирования прода
    'num_requests': 1000,                  # Количество запросов
    'user_id_range': (1000, 9999999),      # Диапазон ID пользователей
    'timeout': 15                          # Таймаут ответа
}

5. Интерпретация метрик
Успешные ответы: Должны быть 100%  
Время ответа:  
Хорошо: < 0.5s  
Допустимо: < 1s  
Критично: > 2s  
Треки на ответ: Всегда 10 (стабильность рекомендательной системы)  

6. Дополнительные команды  
# Тестирование с прогресс-баром  
python test_service.py | grep -v "DEBUG"  

# Экспорт результатов в Excel  
python -c "import pandas as pd; pd.read_csv('test_results.csv').to_excel('report.xlsx')"  

# Просмотр первых 10 записей  
head test_results.csv  

# Статистика по персонализации  
python -c "import pandas as pd; df = pd.read_csv('test_results.csv'); print(df.describe())"  

**Важно**: Перед тестированием убедитесь, что:

- Микросервис запущен и доступен  
- Нет ограничений фаервола  
- Тестовое окружение повторяет продакшен-конфигурацию  


# Анализ результатов работы микросервиса на основе 200 тестовых запросов:

**Распределение рекомендаций:**  
*76% запросов (152/200) → Только популярные треки (0,0,10)*
*24% запросов (48/200) → Персонализированные рекомендации (7,3,0)*  

**Качество персонализации:**

Для пользователей с персонализацией соблюдается баланс между типами рекомендаций:  
*70% персонализированных треков (7 из 10)*
*30% рекомендаций в форме похожих треков (3 из 10)*

## В результатах тестах отсутсвуют ситуации, когда у перльзователя нет пероснальных рекомендаций, но есть история взаимодействия с платформой.

## Это связано с тем, что для всех пользователей, которые хоть раз засветились в рекомендательной системе, были сгенерированы рекомендации на основе синтетических признаков.**

**Проблемные зоны:**    
Высокая доля "холодных" пользователей (76%), что может указывать на:  
Создаваемые генератором случайные пользовательские номера сильно отличаются о тох, которые выдаёт сисема реальным пользователям;
Проблемы в сборе пользовательских данных;  

**Стабильность работы:**  
100% успешных ответов (HTTP 200)  
Нулевая ошибка формирования плейлистов  
Все ответы содержат ровно 10 треков  
Производительность (из предыдущего теста):  
Среднее время ответа: 0.3s  
Минимальное время: 0.1s  
Максимальное время: 1.2s  